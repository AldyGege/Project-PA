<%- include('../partials/__head.ejs') %>
<body>
<div class="container-scroller">
    <%- include('../partials/__nav.ejs') %>
    <div class="main-panel">
        <div class="content-wrapper">
            <div class="container mt-5">
                <div class="row">
                    <div class="col-lg-12 grid-margin stretch-card">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title">Data Pendaftaran</h4>
                                <a href="/pendaftaran/create" class="btn btn-sm btn-success mb-3">Tambah Pendaftaran</a>
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>No</th>
                                                <th>Gambar</th>
                                                <th>Nama Pendaftar</th>
                                                <th>Nama Akun Pendaftar</th>
                                                <th>NIK</th>
                                                <th>Alamat</th>
                                                <th>TTL</th>
                                                <th>Gender</th>
                                                <th>Nama Ortu/Wali</th>
                                                <th>No Telepon Ortu/Wali</th>
                                                <th>Pekerjaan Ortu/Wali</th>
                                                <th>Alamat Ortu/Wali</th>
                                                <th>Waktu Pendaftaran</th>
                                                <th>Status</th>
                                                <th>Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pendaftaran-list">
                                            <% if (data.length > 0) { %>
                                                <% for(var i = 0; i < data.length; i++) { %>
                                                    <tr data-id="<%= data[i].id_pendaftaran %>">
                                                        <th scope="row"><%= (i + 1) %></th>
                                                        <td class="py-1">
                                                            <% if (data[i].gambar_pendaftar) { %>
                                                                <img src="/images/pendaftaran/<%= data[i].gambar_pendaftar %>" height="100" width="150" alt="Gambar Pendaftar"/>
                                                            <% } else { %>
                                                                <span class="text-muted">Tidak ada gambar</span>
                                                            <% } %>
                                                        </td>
                                                        <td><%= data[i].nama_pendaftar %></td>
                                                        <td><%= data[i].nama_users %></td>
                                                        <td><%= data[i].nik %></td>
                                                        <td><%= data[i].alamat_pendaftar %></td>
                                                        <td>
                                                        <% 
                                                            const t = new Date(data[i].ttl);
                                                            const tanggal = ("0" + t.getDate()).slice(-2) + "-" + ("0" + (t.getMonth() + 1)).slice(-2) + "-" + t.getFullYear();
                                                        %>
                                                        <%= tanggal %>
                                                        </td>
                                                        <td><%= data[i].gender %></td>
                                                        <td><%= data[i].nama_ortu_pendaftar %></td>
                                                        <td><%= data[i].no_telp_ortu_pendaftar %></td>
                                                        <td><%= data[i].pekerjaan_ortu_pendaftar %></td>
                                                        <td><%= data[i].alamat_ortu_pendaftar %></td>
                                                        <td><%= data[i].waktu_pendaftaran %></td>
                                                        <td class="status-cell">
                                                            <% if (data[i].status_pendaftaran === "diterima") { %>
                                                                <span class="badge badge-success">Diterima</span>
                                                            <% } else if (data[i].status_pendaftaran === "ditolak") { %>
                                                                <span class="badge badge-danger">Ditolak</span>
                                                            <% } else { %>
                                                                <span class="badge badge-warning">Proses</span>
                                                            <% } %>
                                                        </td>
                                                        <td class="action-cell">
                                                            <% 
                                                                const sudahDaftarUlang = daftarUlangIds.includes(data[i].id_pendaftaran); 
                                                            %>
                                                        
                                                            <% if (data[i].status_pendaftaran === "proses") { %>
                                                                <button class="btn btn-sm btn-success btn-update-status" data-id="<%= data[i].id_pendaftaran %>" data-status="diterima">Diterima</button>
                                                                <button class="btn btn-sm btn-danger btn-update-status" data-id="<%= data[i].id_pendaftaran %>" data-status="ditolak">Ditolak</button>
                                                            <% } else if (!sudahDaftarUlang) { %>
                                                                <!-- Tampilkan tombol batalkan hanya jika belum daftar ulang -->
                                                                <button class="btn btn-sm btn-warning btn-update-status" data-id="<%= data[i].id_pendaftaran %>" data-status="proses">Batalkan</button>
                                                            <% } %>
                                                        </td>
                                                        
                                                    </tr>
                                                <% } %>
                                            <% } else { %>
                                                <tr>
                                                    <td colspan="15" class="text-center">Tidak ada data pendaftaran</td>
                                                </tr>
                                            <% } %>
                                        </tbody>
                                        
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<%- include('../partials/__foot.ejs') %>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("pendaftaran-list").addEventListener("click", function (event) {
            if (event.target.classList.contains("btn-update-status")) {
                const button = event.target;
                const id = button.getAttribute("data-id");
                const status = button.getAttribute("data-status");
    
                // Tampilkan konfirmasi sesuai jenis status
                let confirmText = "";
                if (status === "proses") {
                    confirmText = "Apakah Anda yakin ingin membatalkan status dan mengembalikannya ke 'proses'?";
                } else {
                    confirmText = `Apakah Anda yakin ingin mengubah status menjadi "${status}"?`;
                }
    
                if (confirm(confirmText)) {
                    fetch(`/pendaftaran/update_status/${id}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ status_pendaftaran: status }) 
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("✅ Status berhasil diperbarui!");
    
                            // Ambil elemen baris yang sesuai
                            const row = document.querySelector(`tr[data-id="${id}"]`);
                            const statusCell = row.querySelector(".status-cell");
                            const actionCell = row.querySelector(".action-cell");
    
                            // Update badge status
                            if (status === "diterima") {
                                statusCell.innerHTML = '<span class="badge badge-success">Diterima</span>';
                                actionCell.innerHTML = `<button class="btn btn-sm btn-warning btn-update-status" data-id="${id}" data-status="proses">Batalkan</button>`;
                            } else if (status === "ditolak") {
                                statusCell.innerHTML = '<span class="badge badge-danger">Ditolak</span>';
                                actionCell.innerHTML = `<button class="btn btn-sm btn-warning btn-update-status" data-id="${id}" data-status="proses">Batalkan</button>`;
                            } else if (status === "proses") {
                                statusCell.innerHTML = '<span class="badge badge-warning">Proses</span>';
                                actionCell.innerHTML = `
                                    <button class="btn btn-sm btn-success btn-update-status" data-id="${id}" data-status="diterima">Diterima</button>
                                    <button class="btn btn-sm btn-danger btn-update-status" data-id="${id}" data-status="ditolak">Ditolak</button>
                                `;
                            }
    
                        } else {
                            alert("❌ Gagal memperbarui status. " + data.message);
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        alert("Terjadi kesalahan saat memperbarui status.");
                    });
                }
            }
        });
    });
    </script>
    
    

</body>
